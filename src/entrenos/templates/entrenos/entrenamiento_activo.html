{% extends "base.html" %}
{% load static %}

{% block title %}Entrenamiento Activo - {{ rutina_nombre }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    .notificacion-epica {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
        min-width: 300px;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        border: 2px solid #ffd700;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
        transform: translateX(450px);
        transition: all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        opacity: 0;
        overflow: hidden;
        position: relative;
    }

    .notificacion-epica.mostrar {
        transform: translateX(0);
        opacity: 1;
    }

    .notificacion-epica.ocultar {
        transform: translateX(450px);
        opacity: 0;
    }

    /* Efecto de brillo animado */
    .notificacion-epica::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 215, 0, 0.2), transparent);
        animation: shimmer-notif 2s infinite;
        pointer-events: none;
    }

    @keyframes shimmer-notif {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    /* Tipos de notificaciones */
    .notificacion-epica.ascension {
        border-color: #ff6b6b;
        box-shadow: 0 0 50px rgba(255, 107, 107, 0.6);
    }

    .notificacion-epica.ascension::before {
        background: linear-gradient(45deg, transparent, rgba(255, 107, 107, 0.3), transparent);
    }

    .notificacion-epica.prueba-completada {
        border-color: #4ecdc4;
        box-shadow: 0 0 50px rgba(78, 205, 196, 0.5);
    }

    .notificacion-epica.prueba-completada::before {
        background: linear-gradient(45deg, transparent, rgba(78, 205, 196, 0.2), transparent);
    }

    .notificacion-epica.puntos-ganados {
        border-color: #ffd700;
        box-shadow: 0 0 50px rgba(255, 215, 0, 0.4);
    }

    /* Header de la notificación */
    .notif-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        position: relative;
        z-index: 2;
    }

    .notif-icono {
        font-size: 32px;
        margin-right: 15px;
        animation: pulse-icon 2s infinite;
    }

    @keyframes pulse-icon {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    .notif-titulo {
        color: #ffd700;
        font-size: 18px;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        margin: 0;
    }

    .notif-subtitulo {
        color: #a8dadc;
        font-size: 14px;
        margin: 0;
    }

    /* Contenido de la notificación */
    .notif-contenido {
        position: relative;
        z-index: 2;
        margin-bottom: 15px;
    }

    .notif-mensaje {
        color: #ffffff;
        font-size: 16px;
        line-height: 1.4;
        margin-bottom: 10px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }

    .notif-detalle {
        color: #a8dadc;
        font-size: 14px;
        font-style: italic;
    }

    /* Botón de cerrar */
    .notif-cerrar {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: #a8dadc;
        font-size: 20px;
        cursor: pointer;
        z-index: 3;
        transition: color 0.3s ease;
    }

    .notif-cerrar:hover {
        color: #ffd700;
    }

    /* Efectos de partículas para ascensiones */
    .particulas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
    }

    .particula {
        position: absolute;
        width: 4px;
        height: 4px;
        background: #ffd700;
        border-radius: 50%;
        animation: flotar-particula 3s infinite;
    }

    @keyframes flotar-particula {
        0% {
            transform: translateY(100px) scale(0);
            opacity: 0;
        }
        10% {
            opacity: 1;
        }
        90% {
            opacity: 1;
        }
        100% {
            transform: translateY(-100px) scale(1);
            opacity: 0;
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .notificacion-epica {
            top: 10px;
            right: 10px;
            left: 10px;
            max-width: none;
            transform: translateY(-150px);
        }

        .notificacion-epica.mostrar {
            transform: translateY(0);
        }

        .notificacion-epica.ocultar {
            transform: translateY(-150px);
        }
    }
        .detail-box {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .detail-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.2);
        }

        .detail-label {
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .detail-value {
            font-size: 1.3em;
            font-weight: bold;
            text-shadow: 0 0 10px currentColor;
        }

        .progress-bar {
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
            /* === BASE BODY CYBERPUNK === */
            body {
                background: url("{% static 'images/fondo_cyberpunk.png' %}") no-repeat center center fixed !important;
                background-size: cover !important;
                background-color: #000000 !important;
                min-height: 100vh !important;
                filter: brightness(0.9);
                overflow-x: hidden;
            }

            /* === ANIMACIONES BASE === */
            @keyframes float {
                0% { transform: translateY(0px); }
                50% { transform: translateY(-5px); }
                100% { transform: translateY(0px); }
            }
            .animate-float {
                animation: float 6s ease-in-out infinite;
            }

            @keyframes fadeSlide {
                0% { opacity: 0; transform: translateY(10px); }
                100% { opacity: 1; transform: translateY(0); }
            }
            .animate-fadeSlide {
                animation: fadeSlide 0.8s ease-out;
            }

            @keyframes pulse-neon {
                0%, 100% {
                    box-shadow: 0 0 15px rgba(0, 255, 255, 0.4), inset 0 0 8px rgba(0, 255, 255, 0.2);
                }
                50% {
                    box-shadow: 0 0 25px rgba(0, 255, 255, 0.6), inset 0 0 12px rgba(0, 255, 255, 0.3);
                }
            }
            .pulse-neon {
                animation: pulse-neon 3s ease-in-out infinite;
            }

            @keyframes titleGlow {
                0%, 100% { text-shadow: 0 0 30px rgba(0, 255, 255, 0.5); }
                50% { text-shadow: 0 0 60px rgba(0, 255, 255, 0.8), 0 0 40px rgba(255, 0, 255, 0.6); }
            }

            @keyframes inputGlow {
                0%, 100% { border-color: rgba(0, 255, 255, 0.5); }
                50% { border-color: rgba(0, 255, 255, 0.8); }
            }

            @keyframes dataFlow {
                0% { transform: translateX(-100%); }
                100% { transform: translateX(100%); }
            }

            /* === EFECTOS ATMOSFÉRICOS === */
            .blade-runner-atmosphere {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: -1;
            }

            .background-fog {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: radial-gradient(circle at 30% 20%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
                            radial-gradient(circle at 70% 80%, rgba(255, 0, 255, 0.1) 0%, transparent 50%);
                animation: float 8s ease-in-out infinite;
            }

            /* === CONTENEDOR PRINCIPAL === */
            .cyber-entreno-container {
                max-width: 900px;
                margin: auto;
                background: rgba(0, 0, 0, 0.4) !important;
                backdrop-filter: blur(15px) saturate(180%) !important;
                -webkit-backdrop-filter: blur(15px) saturate(180%) !important;
                border: 1px solid rgba(77, 208, 225, 0.6) !important;
                box-shadow: 0 0 15px rgba(77, 208, 225, 0.4), inset 0 0 8px rgba(77, 208, 225, 0.2) !important;
                border-radius: 20px !important;
                padding: 2rem;
                margin-top: 2rem;
                margin-bottom: 2rem;
                min-height: 80vh;
            }

            /* === HEADER CYBERPUNK === */
            .cyber-entreno-header {
                text-align: center;
                margin-bottom: 2rem;
                padding: 1.5rem;
                background: rgba(0, 0, 0, 0.6) !important;
                backdrop-filter: blur(20px) saturate(180%) !important;
                -webkit-backdrop-filter: blur(20px) saturate(180%) !important;
                border: 1px solid rgba(0, 255, 255, 0.6) !important;
                box-shadow: 0 0 25px rgba(0, 255, 255, 0.3), inset 0 0 15px rgba(0, 255, 255, 0.1) !important;
                border-radius: 15px;
                position: relative;
                overflow: hidden;
            }

            .cyber-entreno-header::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 3px;
                background: linear-gradient(90deg, #00ffff, #ff00ff, #00ff00);
                animation: float 3s ease-in-out infinite;
            }

            .cyber-entreno-header h2 {
                font-size: 2.2rem;
                font-weight: 700;
                background: linear-gradient(90deg, #00ffff, #00ff00, #ff00ff);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                color: transparent;
                text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
                animation: titleGlow 4s ease-in-out infinite alternate;
                margin-bottom: 0.5rem;
            }

            .cyber-entreno-header .lead {
                color: #ffffff;
                font-size: 1.1rem;
                text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
                margin-bottom: 0;
            }

            /* === EJERCICIO CARDS CYBERPUNK === */
            .cyber-ejercicio-card {
                background: rgba(0, 0, 0, 0.6) !important;
                backdrop-filter: blur(15px) saturate(180%) !important;
                -webkit-backdrop-filter: blur(15px) saturate(180%) !important;
                border: 1px solid rgba(77, 208, 225, 0.4) !important;
                box-shadow: 0 0 20px rgba(77, 208, 225, 0.2), inset 0 0 10px rgba(77, 208, 225, 0.1) !important;
                border-radius: 15px;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }

            .cyber-ejercicio-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.1), transparent);
                transition: left 0.6s ease;
            }

            .cyber-ejercicio-card:hover::before {
                left: 100%;
            }

            .cyber-ejercicio-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 0 30px rgba(77, 208, 225, 0.4), inset 0 0 15px rgba(77, 208, 225, 0.2) !important;
                border-color: rgba(0, 255, 255, 0.6) !important;
            }

            /* === EJERCICIO HEADER === */
            .cyber-ejercicio-header {
                border-bottom: 1px solid rgba(0, 255, 255, 0.3) !important;
                padding-bottom: 1rem;
                margin-bottom: 1rem;
            }

            .cyber-ejercicio-header h4 {
                margin: 0;
                color: #00ffff !important;
                font-weight: 700;
                font-size: 1.4rem;
                text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .cyber-ejercicio-header small {
                color: rgba(255, 255, 255, 0.8) !important;
                font-size: 0.9rem;
                margin-top: 0.5rem;
                display: block;
            }

            /* === TABLA CYBERPUNK === */
            .cyber-series-table {
                background: transparent;
                color: #ffffff;
                margin-bottom: 0;
            }

            .cyber-series-table th {
                font-weight: 600;
                color: #00ffff !important;
                border-bottom: 2px solid rgba(0, 255, 255, 0.3) !important;
                background: rgba(0, 255, 255, 0.1);
                text-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
                padding: 1rem 0.75rem;
                font-size: 0.9rem;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .cyber-series-table td {
                border-bottom: 1px solid rgba(0, 255, 255, 0.2) !important;
                background: rgba(0, 0, 0, 0.3);
                padding: 0.75rem;
                vertical-align: middle;
            }

            .cyber-series-table td strong {
                color: #00ffff;
                font-size: 1.1em;
                text-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
            }

            /* === INPUTS CYBERPUNK === */
            .cyber-form-control {
                background: rgba(0, 0, 0, 0.8) !important;
                border: 2px solid rgba(0, 255, 255, 0.4) !important;
                color: #ffffff !important;
                border-radius: 8px;
                padding: 0.5rem 0.75rem;
                transition: all 0.3s ease;
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
                font-weight: 500;
            }

            .cyber-form-control:focus {
                background: rgba(0, 0, 0, 0.9) !important;
                border-color: rgba(0, 255, 255, 0.8) !important;
                box-shadow: 0 0 15px rgba(0, 255, 255, 0.4) !important;
                color: #ffffff !important;
                animation: inputGlow 2s ease-in-out infinite;
                outline: none;
            }

            .cyber-form-control::placeholder {
                color: rgba(255, 255, 255, 0.6) !important;
            }

            /* === CHECKBOX CYBERPUNK === */
            .cyber-form-check-input {
                width: 1.5em;
                height: 1.5em;
                background: rgba(0, 0, 0, 0.8) !important;
                border: 2px solid rgba(0, 255, 255, 0.4) !important;
                border-radius: 4px;
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .cyber-form-check-input:checked {
                background: linear-gradient(45deg, rgba(0, 255, 255, 0.8), rgba(0, 150, 255, 0.6)) !important;
                border-color: rgba(0, 255, 255, 0.8) !important;
                box-shadow: 0 0 15px rgba(0, 255, 255, 0.4) !important;
            }

            .cyber-form-check-input:focus {
                box-shadow: 0 0 10px rgba(0, 255, 255, 0.5) !important;
                outline: none;
            }

            .cyber-form-check-input:hover {
                border-color: rgba(0, 255, 255, 0.6) !important;
                transform: scale(1.1);
            }

            /* === LABELS CYBERPUNK === */
            .cyber-form-label {
                color: #00ffff !important;
                font-weight: 600;
                text-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
                margin-bottom: 0.5rem;
                display: block;
            }

            /* === TEXTAREA CYBERPUNK === */
            .cyber-textarea {
                background: rgba(0, 0, 0, 0.8) !important;
                border: 2px solid rgba(0, 255, 255, 0.4) !important;
                color: #ffffff !important;
                border-radius: 8px;
                padding: 0.75rem;
                transition: all 0.3s ease;
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
                resize: vertical;
                min-height: 100px;
            }

            .cyber-textarea:focus {
                background: rgba(0, 0, 0, 0.9) !important;
                border-color: rgba(0, 255, 255, 0.8) !important;
                box-shadow: 0 0 15px rgba(0, 255, 255, 0.4) !important;
                color: #ffffff !important;
                outline: none;
            }

            .cyber-textarea::placeholder {
                color: rgba(255, 255, 255, 0.6) !important;
            }

            /* === BOTÓN FINALIZAR CYBERPUNK === */
            .cyber-btn-finalizar {
                background: linear-gradient(45deg, rgba(0, 255, 255, 0.8), rgba(0, 150, 255, 0.6)) !important;
                border: 1px solid rgba(0, 255, 255, 0.8) !important;
                color: #000000 !important;
                padding: 1rem 2.5rem;
                border-radius: 12px;
                font-weight: 700;
                font-size: 1.2rem;
                text-decoration: none;
                transition: all 0.3s ease;
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
                box-shadow: 0 0 25px rgba(0, 255, 255, 0.4);
                display: inline-block;
                text-align: center;
                position: relative;
                overflow: hidden;
            }

            .cyber-btn-finalizar::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
                transition: left 0.5s ease;
            }

            .cyber-btn-finalizar:hover::before {
                left: 100%;
            }

            .cyber-btn-finalizar:hover {
                background: linear-gradient(45deg, rgba(0, 255, 255, 1), rgba(0, 150, 255, 0.8)) !important;
                box-shadow: 0 0 35px rgba(0, 255, 255, 0.6);
                transform: translateY(-3px) scale(1.05);
                color: #000000 !important;
            }

            .cyber-btn-finalizar:active {
                transform: translateY(-1px) scale(1.02);
            }

            /* === RESUMEN SECTION === */
            .cyber-resumen-section {
                background: rgba(0, 0, 0, 0.7) !important;
                backdrop-filter: blur(20px) saturate(180%) !important;
                -webkit-backdrop-filter: blur(20px) saturate(180%) !important;
                border: 1px solid rgba(0, 150, 255, 0.6) !important;
                box-shadow: 0 0 25px rgba(0, 150, 255, 0.3), inset 0 0 15px rgba(0, 150, 255, 0.1) !important;
                border-left: 5px solid #0096ff !important;
                border-radius: 15px;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .cyber-resumen-section .cyber-ejercicio-header h4 {
                color: #0096ff !important;
                text-shadow: 0 0 10px rgba(0, 150, 255, 0.5);
            }

            /* === GRID RESPONSIVE === */
            .cyber-row {
                display: flex;
                flex-wrap: wrap;
                margin: -0.5rem;
            }

            .cyber-col-md-6 {
                flex: 0 0 50%;
                max-width: 50%;
                padding: 0.5rem;
            }

            .cyber-col-12 {
                flex: 0 0 100%;
                max-width: 100%;
                padding: 0.5rem;
            }

            /* === EFECTOS ADICIONALES === */
            .cyber-ejercicio-card:nth-child(odd) {
                animation-delay: 0.1s;
            }

            .cyber-ejercicio-card:nth-child(even) {
                animation-delay: 0.2s;
            }

            /* Efecto de progreso en las series completadas */
            .cyber-series-table tr:has(.cyber-form-check-input:checked) {
                background: rgba(0, 255, 100, 0.1) !important;
                border-left: 3px solid #00ff64;
            }

            .cyber-series-table tr:has(.cyber-form-check-input:checked) td {
                color: #00ff64;
                text-shadow: 0 0 5px rgba(0, 255, 100, 0.3);
            }

            /* === RESPONSIVE === */
            @media (max-width: 768px) {
                .cyber-entreno-container {
                    padding: 1rem;
                    margin: 1rem;
                }

                .cyber-entreno-header h2 {
                    font-size: 1.8rem;
                }

                .cyber-ejercicio-card {
                    padding: 1rem;
                }

                .cyber-series-table th,
                .cyber-series-table td {
                    padding: 0.5rem 0.25rem;
                    font-size: 0.85rem;
                }

                .cyber-col-md-6 {
                    flex: 0 0 100%;
                    max-width: 100%;
                }

                .cyber-btn-finalizar {
                    padding: 0.8rem 2rem;
                    font-size: 1.1rem;
                }
            }

            /* === EFECTOS DE CARGA === */
            .loading-effect {
                position: relative;
                overflow: hidden;
            }

            .loading-effect::after {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.2), transparent);
                animation: dataFlow 2s ease-in-out infinite;
            }

            /* === INDICADORES DE ESTADO === */
            .serie-completada {
                position: relative;
            }

            .serie-completada::after {
                content: '✓';
                position: absolute;
                right: -25px;
                top: 50%;
                transform: translateY(-50%);
                color: #00ff64;
                font-weight: bold;
                font-size: 1.2em;
                text-shadow: 0 0 10px rgba(0, 255, 100, 0.5);
            }

            /* === EFECTOS DE FOCUS MEJORADOS === */
            .cyber-form-control:focus,
            .cyber-textarea:focus {
                transform: scale(1.02);
                z-index: 10;
                position: relative;
            }
            /* En templates/clientes/portal_sesion.html, dentro de <style> */

            :root {
                --cyan-glow: rgba(0, 255, 255, 0.7);
                --magenta-glow: rgba(255, 0, 255, 0.6);
                --green-glow: rgba(50, 255, 150, 0.8);
                --yellow-glow: rgba(245, 158, 11, 0.8);
                --red-glow: rgba(239, 68, 68, 0.8);
                --card-bg: rgba(15, 23, 42, 0.7);
                --border-color: rgba(77, 208, 225, 0.3);
                --text-primary: #f8fafc;
                --text-secondary: #94a3b8;
            }

            body {
                background: url("{% static 'images/fondo_cyberpunk.png' %}") no-repeat center center fixed !important;
                background-size: cover !important;
                background-color: #000 !important;
                color: var(--text-primary);
                font-family: 'Inter', sans-serif;
            }

            /* --- Animaciones --- */
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

            /* --- Contenedor Principal --- */
            .mission-container {
                max-width: 800px;
                margin: 2rem auto;
                padding: 2rem;
            }

            /* --- Tarjeta de Fase --- */
            .phase-card {
                background: var(--card-bg);
                backdrop-filter: blur(10px);
                border: 1px solid var(--border-color);
                border-radius: 1rem;
                padding: 2rem;
                margin-bottom: 2rem;
                animation: fadeInUp 0.6s ease-out forwards;
            }

            .phase-header {
                display: flex;
                align-items: center;
                gap: 1rem;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 1rem;
                margin-bottom: 1.5rem;
            }
            .phase-icon {
                font-size: 2rem;
                color: var(--cyan-glow);
                text-shadow: 0 0 10px var(--cyan-glow);
            }
            .phase-title {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--text-primary);
            }
            .phase-subtitle {
                font-size: 1rem;
                color: var(--text-secondary);
            }

            /* --- Estilos para el Formulario de Check-in --- */
            .checkin-form .slider-group { margin-bottom: 1.5rem; }
            .checkin-form .slider-label { display: flex; justify-content: space-between; font-weight: 600; margin-bottom: 0.75rem; }
            .checkin-form .slider-label span:last-child { color: var(--cyan-glow); font-family: monospace; }
            .checkin-form input[type="range"] { width: 100%; accent-color: var(--cyan-glow); }
        /* Añade esto a tu bloque <style> en portal_sesion.html */

        .detail-box {
            background: rgba(0,0,0,0.2);
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        .detail-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .detail-value {
            font-size: 1.25rem;
            font-weight: 700;
            font-family: monospace;
            margin-top: 0.25rem;
        }
        .text-fuchsia-400 { color: #f0abfc; }
        .text-yellow-400 { color: #facc15; }
        .text-cyan-400 { color: #67e8f9; }

            /* --- Tarjeta de Briefing (Recomendación) --- */
            .briefing-card {
                padding: 1.5rem;
                border-radius: 0.75rem;
                border-left: 4px solid;
                margin-bottom: 2rem;
                animation: fadeInUp 0.6s 0.2s ease-out forwards;
                opacity: 0;
            }
            .briefing-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem; }
            .briefing-card.readiness-green { border-color: var(--green-glow); background: rgba(50, 255, 150, 0.1); }
            .briefing-card.readiness-cyan { border-color: var(--cyan-glow); background: rgba(0, 255, 255, 0.1); }
            .briefing-card.readiness-yellow { border-color: var(--yellow-glow); background: rgba(245, 158, 11, 0.1); }
            .briefing-card.readiness-red { border-color: var(--red-glow); background: rgba(239, 68, 68, 0.1); }

            /* --- Tarjeta de Ejercicio --- */
            .exercise-card {
                background: rgba(0,0,0,0.3);
                border-radius: 0.75rem;
                margin-bottom: 1rem;
                overflow: hidden;
                border: 1px solid transparent;
                transition: all 0.3s ease;
            }
            .exercise-card:hover {
                border-color: var(--border-color);
                transform: scale(1.02);
            }
            .exercise-card-header {
                background: rgba(0,0,0,0.4);
                padding: 1rem 1.5rem;
                font-size: 1.2rem;
                font-weight: 600;
                color: var(--cyan-glow);
            }
            .exercise-card-body { padding: 1.5rem; }
            .exercise-table { width: 100%; }
            .exercise-table th, .exercise-table td { padding: 0.5rem; text-align: center; }
            .exercise-table th { color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase; }
            .exercise-table input {
                width: 100%;
                background: var(--dark-bg, #0f172a);
                border: 1px solid var(--border-color);
                color: var(--text-primary);
                text-align: center;
                border-radius: 0.25rem;
                padding: 0.5rem;
            }
        /* En tu plantilla principal, dentro de <style> */

        /* --- Variables de Color y Base (Tu base es excelente) --- */
        :root {
            --color-cyan: #00ffff;
            --color-magenta: #ff00ff;
            --color-green: #32ff00;
            --color-yellow: #f59e0b;
            --color-red: #ef4444;
            --bg-dark: #0a0a1a;
            --bg-card: rgba(15, 23, 42, 0.7);
            --border-color: rgba(0, 255, 255, 0.3);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
        }
        body {
            background: url("{% static 'images/fondo_cyberpunk.png' %}") no-repeat center center fixed !important;
            background-size: cover !important;
            background-color: #000 !important;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
        }
        .container { max-width: 1400px; margin: auto; padding: 2rem; }

        /* --- Componente Base: Tarjeta de Módulo --- */
        .module-card {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }
        .module-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-cyan);
            text-shadow: 0 0 8px var(--color-cyan);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .module-link {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.3s;
        }
        .module-link:hover { color: var(--color-cyan); }

        /* --- Tarjeta de "Próximo Entrenamiento" (Destacada) --- */
        .next-workout-card {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            align-items: center;
        }
        .workout-details h3 { font-size: 1.5rem; font-weight: 700; }
        .workout-details .tags span {
            background: rgba(0, 255, 255, 0.1);
            color: var(--color-cyan);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .workout-exercises { list-style: none; padding: 0; margin-top: 1rem; }
        .workout-exercises li { display: flex; justify-content: space-between; padding: 0.25rem 0; }

        .progress-annual .progress-bar {
            background: rgba(255,255,255,0.1);
            border-radius: 9999px;
            height: 0.75rem;
            overflow: hidden;
        }
        .progress-annual .progress-fill {
            background: linear-gradient(90deg, var(--color-magenta), var(--color-cyan));
            height: 100%;
            border-radius: 9999px;
        }

        /* --- Botones de Acción --- */
        .action-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .action-btn {
            flex-grow: 1;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        .btn-primary {
            background: linear-gradient(45deg, var(--color-cyan), var(--color-magenta));
            color: #000;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }
        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        .action-btn:hover { transform: scale(1.05); }

        /* --- Tarjeta de Adherencia --- */
        .adherence-card { text-align: center; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem; }
        .adherence-card .value { font-size: 2rem; font-weight: 700; }
        .adherence-card .label { font-size: 0.8rem; color: var(--text-secondary); }

        /* --- Alertas Activas --- */
        .alert-card {
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid var(--color-red);
            background: rgba(239, 68, 68, 0.1);
        }
        .alert-card .alert-title { font-weight: 700; color: var(--color-red); }

            /* --- Botón Principal --- */
            .mission-button {
                display: block;
                width: 100%;
                padding: 1rem;
                border: none;
                border-radius: 0.5rem;
                font-size: 1.1rem;
                font-weight: 700;
                color: #000;
                cursor: pointer;
                transition: all 0.3s ease;
                text-align: center;
                background: linear-gradient(45deg, var(--cyan-glow), var(--magenta-glow));
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
            }
            .mission-button:hover {
                transform: scale(1.03);
                box-shadow: 0 0 30px rgba(255, 0, 255, 0.5);
            }

            /* === ANIMACIÓN DE ENTRADA PARA INPUTS === */
            .cyber-form-control,
            .cyber-textarea,
            .cyber-form-check-input {
                animation: fadeSlide 0.6s ease-out;
            }
</style>
{% endblock %}
{% include 'entrenos/notificaciones_epicas.html' %}
{% block content %}
<div id="notificaciones-container"></div>
<div class="blade-runner-atmosphere">
    <div class="background-fog"></div>
</div>


<div class="cyber-entreno-header animate-fadeSlide" style="animation-delay: 0.2s;">
    <h2><i class="fas fa-dumbbell"></i> {{ rutina_nombre }}</h2>
    <p class="lead">Entrenamiento del {{ fecha }} para {{ cliente.nombre }}</p>
</div>
<div class="cyber-ejercicio-card animate-fadeSlide" style="animation-delay: 0.3s; border-left: 5px solid #ff00ff;">
    <div class="cyber-ejercicio-header" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0;">
        <h4><i class="fas fa-brain" style="color: #ff00ff;"></i> Guía de Esfuerzo (RPE)</h4>
        <small>
            El RPE (Ratio de Esfuerzo Percibido) mide qué tan cerca del fallo muscular estás.
            Usa esta guía para calibrar tu intensidad en la última serie de cada ejercicio.
        </small>
        <div class="mt-3 text-sm">
            {% for rpe, desc in leyenda_rpe.items %}
            {% if rpe == '10' or rpe == '9' or rpe == '8' or rpe == '7' or rpe == '6'%} <!-- Solo mostramos los más comunes para no saturar -->
            <p class="mb-1">
                <strong class="text-pink-400">RPE {{ rpe }}:</strong>
                <span class="text-gray-300">{{ desc }}</span>
            </p>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- ======================================================= -->
    <!-- INICIO: LEYENDA DE PROGRESIÓN INTELIGENTE -->
    <!-- ======================================================= -->

    <!-- ======================================================= -->
    <!-- FIN: LEYENDA DE PROGRESIÓN INTELIGENTE -->
    <!-- ======================================================= -->

</div>
<div class="cyber-ejercicio-card animate-fadeSlide" style="animation-delay: 0.3s; border-left: 5px solid #00ff64;">
    <div class="cyber-ejercicio-header" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0;">
        <h4><i class="fas fa-bullseye" style="color: #00ff64;"></i> Tu Misión de Hoy</h4>
        <small>
            Entiende la filosofía detrás de los números para maximizar tu progreso.
        </small>
        <div class="mt-4 text-gray-300 space-y-3">
            <p>
                Tu objetivo principal hoy no es simplemente "hacer 8 repeticiones". Es usar el peso recomendado para alcanzar un nivel de esfuerzo específico (RPE).
            </p>

            <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                <p>
                    <strong class="text-cyan-400">El Peso es tu Herramienta:</strong> Te hemos asignado un peso calculado para tu fuerza actual.
                </p>
                <p class="mt-2">
                    <strong class="text-pink-400">El RPE es tu Límite:</strong> Tu verdadera meta es terminar la última serie sintiendo el <strong class="font-bold">RPE Objetivo</strong>. Esto significa que deberías sentir que te quedan en
                    recámara el número de repeticiones que indica la guía de abajo.
                </p>
                <p class="mt-2">
                    <strong class="text-yellow-400">Las Reps son tu Puntuación:</strong> El rango de repeticiones es donde esperamos que aterrices.
                </p>
                <ul class="list-disc list-inside pl-4 mt-2 text-sm">
                    <li>Si haces **más repeticiones** de las esperadas para ese RPE, ¡genial! Tu fuerza ha aumentado y lo registraremos.</li>
                    <li>Si haces **menos repeticiones**, no pasa nada. Significa que el peso fue un gran desafío hoy. También lo registraremos.</li>
                </ul>
            </div>

            <p class="font-semibold text-white">
                En resumen: Usa el peso, apunta al RPE y registra honestamente las repeticiones que consigas. ¡Ahí está la clave de tu progreso!
            </p>
        </div>
    </div>
</div>
<!-- WIDGET DE GAMIFICACIÓN -->
<!-- Widget de Gamificación para entrenamiento_activo.html -->
<!-- Añadir DESPUÉS de la sección de "Guía de Esfuerzo (RPE)" y ANTES del formulario -->
{% include 'entrenos/widget_codice.html' %}
<div class="cyber-ejercicio-card animate-fadeSlide" style="animation-delay: 0.2s; border-left: 5px solid #ffd700;">
    <div class="cyber-ejercicio-header">
        <h4><i class="fas fa-trophy" style="color: #ffd700;"></i> Códice de las Leyendas</h4>
        <small>Tu progreso épico hacia convertirte en una leyenda - {{ cliente.nombre }}</small>
    </div>

    {% if resumen_gamificacion.tiene_perfil %}
    <div class="row mb-3">
        <!-- Nivel Actual -->
        <div class="col-md-4">
            <div class="detail-box" style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3);">
                <div class="detail-label" style="color: #ffd700;">
                    <i class="fas fa-crown"></i> Nivel Actual
                </div>
                <div class="detail-value" style="color: #ffd700; font-size: 1.1em;">
                    {{ resumen_gamificacion.nivel_actual }}
                </div>
            </div>
        </div>

        <!-- Puntos -->
        <div class="col-md-4">
            <div class="detail-box" style="background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3);">
                <div class="detail-label" style="color: #00ffff;">
                    <i class="fas fa-star"></i> Puntos
                </div>
                <div class="detail-value" style="color: #00ffff; font-size: 1.1em;">
                    {{ resumen_gamificacion.puntos_actuales|floatformat:0 }}
                </div>
            </div>
        </div>

        <!-- Racha -->
        <div class="col-md-4">
            <div class="detail-box" style="background: rgba(255, 0, 255, 0.1); border: 1px solid rgba(255, 0, 255, 0.3);">
                <div class="detail-label" style="color: #ff00ff;">
                    <i class="fas fa-fire"></i> Racha
                </div>
                <div class="detail-value" style="color: #ff00ff; font-size: 1.1em;">
                    {{ resumen_gamificacion.racha_actual }} días
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de Progreso hacia el siguiente nivel -->
    <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <small style="color: #ffd700;">
                <i class="fas fa-arrow-up"></i> Progreso hacia: {{ resumen_gamificacion.siguiente_nivel }}
            </small>
            <small style="color: #00ffff;">
                {{ resumen_gamificacion.porcentaje_progreso }}%
            </small>
        </div>
        <div class="progress" style="height: 12px; background: rgba(0,0,0,0.6); border-radius: 6px; overflow: hidden;">
            <div class="progress-bar"
                 style="background: linear-gradient(90deg, #ffd700, #ffed4e);
                        width: {{ resumen_gamificacion.porcentaje_progreso }}%;
                        transition: width 0.5s ease;
                        box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);">
            </div>
        </div>
        <div class="d-flex justify-content-between mt-1">
            <small style="color: rgba(255, 255, 255, 0.6);">
                {{ resumen_gamificacion.puntos_actuales|floatformat:0 }} pts
            </small>
            <small style="color: rgba(255, 255, 255, 0.6);">
                {{ resumen_gamificacion.puntos_siguiente|floatformat:0 }} pts
            </small>
        </div>
    </div>

    <!-- Pruebas Activas -->
    {% if resumen_gamificacion.pruebas_activas %}
    <div class="mt-3">
        <h6 style="color: #00ffff; margin-bottom: 15px;">
            <i class="fas fa-target"></i> Pruebas Legendarias Activas:
        </h6>
        {% for prueba_usuario in resumen_gamificacion.pruebas_activas %}
        <div class="mb-3 p-3" style="background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(0,255,255,0.1));
                                     border-left: 4px solid #ffd700;
                                     border-radius: 8px;
                                     backdrop-filter: blur(5px);">
            <div class="d-flex justify-content-between align-items-start">
                <div style="flex: 1;">
                    <strong style="color: #ffd700; font-size: 1.1em;">
                        {{ prueba_usuario.prueba.nombre }}
                    </strong>
                    <br>
                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 0.95em;">
                        {{ prueba_usuario.prueba.descripcion }}
                    </span>
                </div>
                <div class="text-right">
                    <span style="color: #00ffff; font-weight: bold; font-size: 1.1em;">
                        +{{ prueba_usuario.prueba.puntos_recompensa }} pts
                    </span>
                    {% if prueba_usuario.prueba.es_secreta %}
                    <br>
                    <small style="color: #ff00ff;">
                        <i class="fas fa-eye-slash"></i> Secreta
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Filosofía del nivel actual -->
    {% if resumen_gamificacion.perfil.arquetipo_actual %}
    <div class="mt-3 p-3" style="background: rgba(0, 0, 0, 0.4);
                                 border: 1px solid rgba(255, 215, 0, 0.3);
                                 border-radius: 8px;
                                 font-style: italic;">
        <div style="color: #ffd700; font-size: 0.9em; margin-bottom: 5px;">
            <i class="fas fa-quote-left"></i> Filosofía de {{ resumen_gamificacion.nivel_actual }}:
        </div>
        <div style="color: rgba(255, 255, 255, 0.9); font-size: 0.95em; line-height: 1.4;">
            "{{ resumen_gamificacion.perfil.arquetipo_actual.filosofia }}"
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Mensaje para nuevos usuarios -->
    <div class="text-center p-4" style="background: rgba(255, 215, 0, 0.1); border-radius: 10px;">
        <div style="color: #ffd700; font-size: 2em; margin-bottom: 10px;">
            <i class="fas fa-star"></i>
        </div>
        <h5 style="color: #ffd700; margin-bottom: 15px;">
            ¡Bienvenido al Códice de las Leyendas!
        </h5>
        <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 15px;">
            Completa tu primer entrenamiento para comenzar tu viaje épico hacia convertirte en una leyenda.
        </p>
        <div style="color: #00ffff; font-size: 1.1em;">
            <i class="fas fa-fist-raised"></i> Nivel Inicial: El Aspirante Calvo
        </div>
        <small style="color: rgba(255, 255, 255, 0.7); display: block; margin-top: 10px;">
            "Todo poder comienza con 100 flexiones, 100 abdominales, 100 sentadillas y 10km de carrera"
        </small>
    </div>
    {% endif %}

    <!-- Enlace al Códice completo -->
    <div class="text-center mt-3">
        <a href="{% url 'logros:perfil_gamificacion' cliente.id %}"
           class="btn"
           style="background: linear-gradient(45deg, #ffd700, #ffed4e);
                  color: #000;
                  border: none;
                  padding: 8px 20px;
                  border-radius: 20px;
                  font-weight: bold;
                  text-decoration: none;
                  transition: all 0.3s ease;
                  box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);"
           onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 215, 0, 0.4)';"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 215, 0, 0.3)';">
            <i class="fas fa-book-open"></i> Ver Códice Completo
        </a>
    </div>
</div>


<!-- INSTRUCCIONES DE INTEGRACIÓN:

1. AÑADIR AL CONTEXTO DE LA VISTA:
   En tu vista de entrenamiento_activo, añadir:

   from .gamificacion_service import EntrenamientoGamificacionService

   def entrenamiento_activo(request, cliente_id):
       # ... tu código existente ...

       # Añadir al contexto:
       resumen_gamificacion = EntrenamientoGamificacionService.obtener_resumen_gamificacion(cliente)
       context['resumen_gamificacion'] = resumen_gamificacion

       return render(request, 'entrenos/entrenamiento_activo.html', context)

2. POSICIÓN EN EL TEMPLATE:
   Colocar este widget DESPUÉS de la sección "Guía de Esfuerzo (RPE)"
   y ANTES del formulario de entrenamiento.

3. DEPENDENCIAS:
   - Asegurar que las URLs de logros estén configuradas
   - Verificar que el servicio de gamificación esté funcionando
   - Confirmar que los modelos de logros estén migrados

-->


<form action="{% url 'entrenos:guardar_entrenamiento_activo' cliente.id %}" method="POST">
    {% csrf_token %}
    <input type="hidden" name="fecha" value="{{ fecha }}">
    <input type="hidden" name="rutina_nombre" value="{{ rutina_nombre }}">

    {% for ejercicio in ejercicios_planificados %}
    <div class="exercise-card-body" style="animation-delay: {{ forloop.counter0|add:2|stringformat:'.1f' }}s;">
        <div class="cyber-ejercicio-header">
            <h4><i class="fas fa-robot"></i> {{ ejercicio.nombre|title }}</h4>
            <small>
                <strong class="text-pink-400">Misión:</strong> {{ ejercicio.series }} series a <strong>RPE {{ ejercicio.rpe_objetivo }}</strong> con <strong>{{ ejercicio.peso_recomendado_kg }} kg</strong>.


                <span class="text-gray-400">Rango de reps esperado: {{ ejercicio.repeticiones }}. ¡Intenta superarlo!</span>
            </small>
            <input type="hidden" name="{{ ejercicio.form_id }}_nombre" value="{{ ejercicio.nombre }}">
        </div>
        <div class="grid grid-cols-3 gap-4 mb-6 text-center">
            <div class="detail-box">
                <div class="detail-label">RPE Objetivo</div>
                <div class="detail-value text-fuchsia-400">{{ ejercicio.rpe_objetivo }}</div>
            </div>
            <div class="detail-box">
                <div class="detail-label">Tempo</div>
                <div class="detail-value text-yellow-400">{{ ejercicio.tempo }}</div>
            </div>
            <div class="detail-box">
                <div class="detail-label">Descanso</div>
                <div class="detail-value text-cyan-400">{{ ejercicio.descanso_minutos }} min</div>
            </div>
        </div>

        <table class="exercise-table">
            <thead>
            <tr>
                <th class="w-1/6">Serie</th>
                <th class="w-1/4">Peso (kg)</th>
                <th class="w-1/4">Reps Realizadas</th>
                <!-- ======================================================= -->
                <!-- CAMBIO: Ancho aumentado para RPE Sentido -->
                <!-- ======================================================= -->
                <th class="w-1/3 text-center">RPE Sentido</th>
                <th class="w-1/12">Hecho</th>
            </tr>
            </thead>
            <tbody>
            <!-- ======================================================= -->
            <!-- INICIO DE LA CORRECCIÓN PRINCIPAL -->
            <!-- ======================================================= -->
            {% for i in ""|center:ejercicio.series %}
            {% with forloop.counter as serie_num %}
            <tr>
                <td class="align-middle"><strong>{{ serie_num }}</strong></td>
                <td>
                    <input type="number" step="0.5" class="form-control cyber-form-control"
                           name="{{ ejercicio.form_id }}_peso_{{ serie_num }}"
                           value="{{ ejercicio.peso_recomendado_kg|stringformat:'.1f' }}">
                </td>
                <td>
                    <input type="number" class="form-control cyber-form-control"
                           name="{{ ejercicio.form_id }}_reps_{{ serie_num }}"
                           value="{{ ejercicio.reps_objetivo }}">
                </td>
                <td>
                    <!-- Input para el RPE Real -->
                    <input type="number" step="0.5" class="form-control cyber-form-control text-center"
                           name="{{ ejercicio.form_id }}_rpe_{{ serie_num }}"
                           value="{{ ejercicio.rpe_objetivo }}">
                </td>
                <td class="text-center align-middle">
                    <input class="form-check-input cyber-form-check-input" type="checkbox"
                           name="{{ ejercicio.form_id }}_completado_{{ serie_num }}"
                           value="1" checked>
                </td>
            </tr>
            {% endwith %}
            {% endfor %}
            </tbody>
        </table>
    </div>

    {% endfor %}

    <!-- Sección de resumen y botón (sin cambios) -->
    <div class="cyber-ejercicio-card cyber-resumen-section ...">
        <div class="cyber-ejercicio-card cyber-resumen-section animate-fadeSlide" style="animation-delay: {{ ejercicios_planificados|length|add:3|floatformat:1 }}s;">
            <div class="cyber-ejercicio-header">
                <h4><i class="fas fa-chart-line"></i> Resumen del Entrenamiento</h4>
                <small>Datos generales de la sesión</small>
            </div>
            <div class="cyber-row">
                <div class="cyber-col-md-6">
                    <label for="duracion_minutos" class="cyber-form-label">Duración Total (minutos)</label>
                    <input type="number" class="form-control cyber-form-control" id="duracion_minutos"
                           name="duracion_minutos" placeholder="Ej: 75">
                </div>
                <div class="cyber-col-md-6">
                    <label for="calorias_quemadas" class="cyber-form-label">Calorías Quemadas (opcional)</label>
                    <input type="number" class="form-control cyber-form-control" id="calorias_quemadas"
                           name="calorias_quemadas" placeholder="Ej: 550">
                </div>
                <div class="cyber-col-12">
                    <label for="notas_liftin" class="cyber-form-label">Notas Generales</label>
                    <textarea class="form-control cyber-textarea" id="notas_liftin" name="notas_liftin"
                              rows="3" placeholder="¿Cómo te sentiste? ¿Alguna molestia?"></textarea>
                </div>
            </div>
        </div>
    </div>
    <div class="text-center mt-4 ...">
        <button type="submit" class="btn cyber-btn-finalizar">
            <i class="fas fa-save"></i> Finalizar y Guardar Entrenamiento
        </button>
        <a href="{% url 'analytics:dashboard_cliente' cliente.id %}" class="btn btn-cyber">
            📊 Ver Dashboard Completo
        </a>
    </div>
</form>


{% endblock %}

{% block extra_js %}
<script>

    class NotificacionesCodeice {
        constructor() {
            this.container = document.getElementById('notificaciones-container');
            this.notificacionesActivas = [];
            this.sonidosHabilitados = true;
        }

        // Mostrar notificación de puntos ganados
        mostrarPuntosGanados(puntos, desglose = null) {
            const notificacion = {
                tipo: 'puntos-ganados',
                icono: '💰',
                titulo: '¡Puntos Ganados!',
                subtitulo: 'Recompensa de Entrenamiento',
                mensaje: `+${puntos} puntos de poder`,
                detalle: desglose ? `${desglose.base} base + ${desglose.bonus} bonus + ${desglose.pruebas} pruebas` : null,
                duracion: 4000
            };

            this.mostrarNotificacion(notificacion);
        }

        // Mostrar notificación de prueba completada
        mostrarPruebaCompletada(nombrePrueba, puntosRecompensa, descripcion = null) {
            const notificacion = {
                tipo: 'prueba-completada',
                icono: '⚔️',
                titulo: '¡Prueba Completada!',
                subtitulo: nombrePrueba,
                mensaje: `Has superado el desafío legendario`,
                detalle: descripcion || `+${puntosRecompensa} puntos de recompensa`,
                duracion: 6000,
                efectos: true
            };

            this.mostrarNotificacion(notificacion);
        }

        // Mostrar notificación de ascensión
        mostrarAscension(nivelAnterior, nivelNuevo, filosofia = null) {
            const notificacion = {
                tipo: 'ascension',
                icono: '🔥',
                titulo: '¡ASCENSIÓN!',
                subtitulo: `${nivelAnterior} → ${nivelNuevo}`,
                mensaje: `Has alcanzado un nuevo nivel de poder`,
                detalle: filosofia ? `"${filosofia}"` : 'Tu leyenda continúa creciendo',
                duracion: 8000,
                efectos: true,
                particulas: true
            };

            this.mostrarNotificacion(notificacion);
        }

        // Mostrar notificación de racha
        mostrarRacha(dias) {
            if (dias < 3) return; // Solo mostrar rachas significativas

            const notificacion = {
                tipo: 'puntos-ganados',
                icono: '🔥',
                titulo: '¡Racha de Fuego!',
                subtitulo: `${dias} días consecutivos`,
                mensaje: `Tu dedicación arde como una llama eterna`,
                detalle: `Bonus de constancia: +${Math.min(15, dias)} puntos`,
                duracion: 5000
            };

            this.mostrarNotificacion(notificacion);
        }

        // Función principal para mostrar notificaciones
        mostrarNotificacion(config) {
            const notifElement = this.crearElementoNotificacion(config);
            this.container.appendChild(notifElement);
            this.notificacionesActivas.push(notifElement);

            // Mostrar con animación
            setTimeout(() => {
                notifElement.classList.add('mostrar');
            }, 100);

            // Añadir efectos especiales
            if (config.efectos) {
                this.añadirEfectosPulso(notifElement);
            }

            if (config.particulas) {
                this.añadirParticulas(notifElement);
            }

            // Auto-ocultar después de la duración especificada
            setTimeout(() => {
                this.ocultarNotificacion(notifElement);
            }, config.duracion);

            // Reposicionar notificaciones existentes
            this.reposicionarNotificaciones();
        }

        // Crear elemento HTML de la notificación
        crearElementoNotificacion(config) {
            const notif = document.createElement('div');
            notif.className = `notificacion-epica ${config.tipo}`;

            notif.innerHTML = `
                <button class="notif-cerrar" onclick="notificacionesCodeice.ocultarNotificacion(this.parentElement)">&times;</button>

                <div class="notif-header">
                    <div class="notif-icono">${config.icono}</div>
                    <div>
                        <div class="notif-titulo">${config.titulo}</div>
                        <div class="notif-subtitulo">${config.subtitulo}</div>
                    </div>
                </div>

                <div class="notif-contenido">
                    <div class="notif-mensaje">${config.mensaje}</div>
                    ${config.detalle ? `<div class="notif-detalle">${config.detalle}</div>` : ''}
                </div>
            `;

            return notif;
        }

        // Ocultar notificación
        ocultarNotificacion(elemento) {
            elemento.classList.add('ocultar');

            setTimeout(() => {
                if (elemento.parentNode) {
                    elemento.parentNode.removeChild(elemento);
                }

                const index = this.notificacionesActivas.indexOf(elemento);
                if (index > -1) {
                    this.notificacionesActivas.splice(index, 1);
                }

                this.reposicionarNotificaciones();
            }, 800);
        }

        // Reposicionar notificaciones para evitar solapamiento
        reposicionarNotificaciones() {
            let offset = 20;
            this.notificacionesActivas.forEach((notif, index) => {
                if (notif.classList.contains('mostrar') && !notif.classList.contains('ocultar')) {
                    notif.style.top = `${offset}px`;
                    offset += notif.offsetHeight + 15;
                }
            });
        }

        // Añadir efectos de pulso
        añadirEfectosPulso(elemento) {
            // Implementación opcional
        }

        // Añadir partículas para ascensiones
        añadirParticulas(elemento) {
            const particulasContainer = document.createElement('div');
            particulasContainer.className = 'particulas';

            for (let i = 0; i < 15; i++) {
                const particula = document.createElement('div');
                particula.className = 'particula';
                particula.style.left = `${Math.random() * 100}%`;
                particula.style.animationDelay = `${Math.random() * 2}s`;
                particula.style.animationDuration = `${2 + Math.random() * 2}s`;
                particulasContainer.appendChild(particula);
            }

            elemento.appendChild(particulasContainer);

            setTimeout(() => {
                if (particulasContainer.parentNode) {
                    particulasContainer.parentNode.removeChild(particulasContainer);
                }
            }, 4000);
        }

        // Limpiar todas las notificaciones
        limpiarTodas() {
            this.notificacionesActivas.forEach(notif => {
                this.ocultarNotificacion(notif);
            });
        }
    }

    // Instancia global del sistema de notificaciones
    const notificacionesCodeice = new NotificacionesCodeice();

    // Funciones de conveniencia para usar desde otros scripts
    function mostrarNotificacionPuntos(puntos, desglose = null) {
        notificacionesCodeice.mostrarPuntosGanados(puntos, desglose);
    }

    function mostrarNotificacionPrueba(nombre, puntos, descripcion = null) {
        notificacionesCodeice.mostrarPruebaCompletada(nombre, puntos, descripcion);
    }

    function mostrarNotificacionAscension(anterior, nuevo, filosofia = null) {
        notificacionesCodeice.mostrarAscension(anterior, nuevo, filosofia);
    }

    function mostrarNotificacionRacha(dias) {
        notificacionesCodeice.mostrarRacha(dias);
    }

    console.log('🎮 Sistema de notificaciones épicas cargado');

        document.addEventListener('DOMContentLoaded', function() {
            // Efectos adicionales de interactividad
            const ejercicioCards = document.querySelectorAll('.cyber-ejercicio-card');
            ejercicioCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-3px)';
                });

                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });

            // Efectos para inputs
            const inputs = document.querySelectorAll('.cyber-form-control, .cyber-textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.parentNode.style.transform = 'scale(1.02)';
                    this.parentNode.style.zIndex = '10';
                });

                input.addEventListener('blur', function() {
                    this.parentNode.style.transform = 'scale(1)';
                    this.parentNode.style.zIndex = '1';
                });
            });

            // Efectos para checkboxes
            const checkboxes = document.querySelectorAll('.cyber-form-check-input');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const row = this.closest('tr');
                    if (this.checked) {
                        row.classList.add('serie-completada');
                        // Efecto de completado
                        row.style.background = 'rgba(0, 255, 100, 0.1)';
                        row.style.borderLeft = '3px solid #00ff64';

                        // Animación de éxito
                        this.style.transform = 'scale(1.2)';
                        setTimeout(() => {
                            this.style.transform = 'scale(1)';
                        }, 200);
                    } else {
                        row.classList.remove('serie-completada');
                        row.style.background = '';
                        row.style.borderLeft = '';
                    }
                });

                checkbox.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.1)';
                });

                checkbox.addEventListener('mouseleave', function() {
                    if (!this.matches(':focus')) {
                        this.style.transform = 'scale(1)';
                    }
                });
            });

            // Efecto de progreso general
            function updateProgress() {
                const totalCheckboxes = checkboxes.length;
                const checkedBoxes = document.querySelectorAll('.cyber-form-check-input:checked').length;
                const progress = (checkedBoxes / totalCheckboxes) * 100;

                // Actualizar color del botón según progreso
                const finalizarBtn = document.querySelector('.cyber-btn-finalizar');
                if (progress === 100) {
                    finalizarBtn.style.background = 'linear-gradient(45deg, rgba(0, 255, 100, 0.8), rgba(0, 200, 50, 0.6))';
                    finalizarBtn.style.boxShadow = '0 0 35px rgba(0, 255, 100, 0.6)';
                } else {
                    finalizarBtn.style.background = 'linear-gradient(45deg, rgba(0, 255, 255, 0.8), rgba(0, 150, 255, 0.6))';
                    finalizarBtn.style.boxShadow = '0 0 25px rgba(0, 255, 255, 0.4)';
                }
            }

            // Escuchar cambios en checkboxes para actualizar progreso
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateProgress);
            });

            // Inicializar progreso
            updateProgress();

            // Efecto de envío del formulario
            const form = document.querySelector('form');
            form.addEventListener('submit', function(e) {
                const submitBtn = document.querySelector('.cyber-btn-finalizar');
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
                submitBtn.disabled = true;

                // Efecto visual de envío
                submitBtn.style.background = 'linear-gradient(45deg, rgba(255, 165, 0, 0.8), rgba(255, 140, 0, 0.6))';
                submitBtn.style.boxShadow = '0 0 35px rgba(255, 165, 0, 0.6)';
            });

            // Validación mejorada
            const requiredInputs = document.querySelectorAll('input[required], textarea[required]');
            requiredInputs.forEach(input => {
                input.addEventListener('invalid', function() {
                    this.style.borderColor = 'rgba(220, 53, 69, 0.8)';
                    this.style.boxShadow = '0 0 15px rgba(220, 53, 69, 0.4)';
                });

                input.addEventListener('input', function() {
                    if (this.validity.valid) {
                        this.style.borderColor = 'rgba(0, 255, 255, 0.4)';
                        this.style.boxShadow = '';
                    }
                });
            });

            // Efecto de carga inicial
            setTimeout(() => {
                document.body.classList.add('loaded');
            }, 500);
        });

      document.addEventListener('DOMContentLoaded', function() {
    console.log('🎮 Sistema de notificaciones del Códice iniciado');

    // Verificar si hay mensajes de Django para procesar
    {% if messages %}
        let delay = 1000; // Delay inicial de 1 segundo
        let messageCount = 0;

        {% for message in messages %}
            messageCount++;
            // USAR LET EN LUGAR DE CONST PARA EVITAR CONFLICTOS
            let currentMessage = "{{ message.message|escapejs }}";
            console.log(`📨 Procesando mensaje ${messageCount}:`, currentMessage);

            // PROCESAR PUNTOS GANADOS
            if (currentMessage.startsWith('CODICE_PUNTOS:')) {
                try {
                    const puntosData = JSON.parse(currentMessage.replace('CODICE_PUNTOS:', ''));
                    console.log('💰 Datos de puntos:', puntosData);

                    setTimeout(() => {
                        mostrarNotificacionPuntos(puntosData.total, {
                            base: puntosData.base,
                            bonus: puntosData.bonus,
                            pruebas: puntosData.pruebas
                        });
                    }, delay);

                    delay += 1500;
                } catch (e) {
                    console.error('Error procesando puntos:', e);
                }
            }

            // PROCESAR PRUEBAS COMPLETADAS
            else if (currentMessage.startsWith('CODICE_PRUEBA:')) {
                try {
                    const pruebaData = JSON.parse(currentMessage.replace('CODICE_PRUEBA:', ''));
                    console.log('⚔️ Datos de prueba:', pruebaData);

                    setTimeout(() => {
                        mostrarNotificacionPrueba(
                            pruebaData.nombre,
                            pruebaData.puntos,
                            pruebaData.descripcion
                        );
                    }, delay);

                    delay += 2000;
                } catch (e) {
                    console.error('Error procesando prueba:', e);
                }
            }

            // PROCESAR ASCENSIONES
            else if (currentMessage.startsWith('CODICE_ASCENSION:')) {
                try {
                    const ascensionData = JSON.parse(currentMessage.replace('CODICE_ASCENSION:', ''));
                    console.log('🔥 Datos de ascensión:', ascensionData);

                    setTimeout(() => {
                        mostrarNotificacionAscension(
                            ascensionData.anterior,
                            ascensionData.nuevo,
                            ascensionData.filosofia
                        );
                    }, delay);

                    delay += 3000;
                } catch (e) {
                    console.error('Error procesando ascensión:', e);
                }
            }

            // PROCESAR RACHAS
            else if (currentMessage.startsWith('CODICE_RACHA:')) {
                try {
                    const dias = parseInt(currentMessage.replace('CODICE_RACHA:', ''));
                    console.log('🔥 Racha de días:', dias);

                    setTimeout(() => {
                        mostrarNotificacionRacha(dias);
                    }, delay);

                    delay += 1500;
                } catch (e) {
                    console.error('Error procesando racha:', e);
                }
            }

            // MENSAJE NORMAL (no es del Códice)
            else if (!currentMessage.startsWith('CODICE_')) {
                console.log('📝 Mensaje normal:', currentMessage);
            }
        {% endfor %}

        console.log(`🎮 Procesamiento completado. ${messageCount} mensajes, delay total: ${delay}ms`);
    {% else %}
        console.log('📭 No hay mensajes para procesar');
    {% endif %}
});

// FUNCIONES DE TESTING
function testNotificaciones() {
    console.log('🧪 Iniciando test de notificaciones...');

    setTimeout(() => {
        mostrarNotificacionPuntos(47, {base: 25, bonus: 7, pruebas: 15});
    }, 1000);

    setTimeout(() => {
        mostrarNotificacionPrueba("Las Puertas del Esfuerzo", 150, "7 días consecutivos completados");
    }, 3000);

    setTimeout(() => {
        mostrarNotificacionAscension("Rock Lee", "Krillin - El Guerrero Humano", "Tu corazón valiente te hace fuerte");
    }, 5000);

    setTimeout(() => {
        mostrarNotificacionRacha(5);
    }, 7000);
}

// LIMPIAR MENSAJES DJANGO DESPUÉS DE PROCESARLOS
function limpiarMensajesDjango() {
    const djangoMessages = document.querySelectorAll('.alert, .messages li, .message');
    djangoMessages.forEach(msg => {
        if (msg.textContent.includes('CODICE_')) {
            msg.style.display = 'none';
        }
    });
}

setTimeout(limpiarMensajesDjango, 500);

console.log('🎮 Códice de las Leyendas - Sistema de notificaciones cargado');
console.log('🧪 Para probar notificaciones, ejecuta: testNotificaciones()');

    // FUNCIONES DE CONVENIENCIA PARA TESTING
    function testNotificaciones() {
        console.log('🧪 Iniciando test de notificaciones...');

        // Test puntos
        setTimeout(() => {
            mostrarNotificacionPuntos(47, {base: 25, bonus: 7, pruebas: 15});
        }, 1000);

        // Test prueba
        setTimeout(() => {
            mostrarNotificacionPrueba("Las Puertas del Esfuerzo", 150, "7 días consecutivos completados");
        }, 3000);

        // Test ascensión
        setTimeout(() => {
            mostrarNotificacionAscension("Rock Lee", "Krillin - El Guerrero Humano", "Tu corazón valiente te hace fuerte");
        }, 5000);

        // Test racha
        setTimeout(() => {
            mostrarNotificacionRacha(5);
        }, 7000);
    }

    // FUNCIÓN PARA LIMPIAR MENSAJES DESPUÉS DE MOSTRAR NOTIFICACIONES
    function limpiarMensajesDjango() {
        // Opcional: ocultar los mensajes Django estándar después de procesarlos
        const djangoMessages = document.querySelectorAll('.alert, .messages li, .message');
        djangoMessages.forEach(msg => {
            if (msg.textContent.includes('CODICE_')) {
                msg.style.display = 'none';
            }
        });
    }

    // Limpiar mensajes después de procesarlos
    setTimeout(limpiarMensajesDjango, 500);

    // DEBUGGING: Mostrar en consola cuando se carga la página
    console.log('🎮 Códice de las Leyendas - Sistema de notificaciones cargado');
    console.log('🧪 Para probar notificaciones, ejecuta: testNotificaciones()');
</script>

{% endblock %}

