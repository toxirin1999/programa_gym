{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Nivel 1: Balance Energético – {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* Estilos base del mockup (copiados para consistencia ) */
    body {
      background: url("{% static 'images/fondo_cyberpunk.png' %}") no-repeat center center fixed !important;
      background-size: cover !important;
      background-color: #000000 !important;
      min-height: 100vh !important;
      filter: brightness(0.9);
      overflow-x: hidden;
    }
    .panel-card {
        background: rgba(10, 15, 25, 0.5) !important;
        backdrop-filter: blur(18px) saturate(150%) !important;
        -webkit-backdrop-filter: blur(18px) saturate(150%) !important;
        border: 1px solid rgba(77, 208, 225, 0.4) !important;
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.15), inset 0 0 10px rgba(77, 208, 225, 0.1) !important;
        border-radius: 12px !important;
        color: #fff;
        padding: 1.5rem;
    }
    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: white;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .btn-gradient {
        color: #fff;
        font-weight: 600;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
    }
    .btn-gradient.primary {
        background: linear-gradient(90deg, #00A3FF, #9E00FF);
        box-shadow: 0 0 15px rgba(0, 163, 255, 0.4);
    }
    .btn-gradient.primary:hover {
        box-shadow: 0 0 25px rgba(158, 0, 255, 0.6);
        transform: scale(1.03);
    }
    .btn-secondary-outline {
        background: rgba(10, 15, 25, 0.3);
        border: 1px solid rgba(77, 208, 225, 0.5);
        color: #9ca3af;
        padding: 10px 20px;
        border-radius: 8px;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
    }
    .btn-secondary-outline:hover {
        background: rgba(77, 208, 225, 0.1);
        color: #fff;
        border-color: rgba(77, 208, 225, 0.8);
    }
    .animate-fadeSlide {
      animation: fadeSlide 0.8s ease-out forwards;
    }
    @keyframes fadeSlide {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Estilos para el formulario */
    .form-label {
        font-weight: 500;
        color: #cbd5e1; /* slate-300 */
        margin-bottom: 0.5rem;
    }
    .form-range {
        accent-color: #00ffff;
    }
    .form-check-input:checked {
        background-color: #00ffff;
        border-color: #00ffff;
    }
    .form-check-label {
        color: #e5e7eb;
    }
    .info-box {
        background: rgba(10, 15, 25, 0.7);
        border: 1px solid rgba(77, 208, 225, 0.2);
        border-radius: 8px;
        padding: 1rem;
        font-size: 0.875rem;
        color: #9ca3af;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">

    <!-- Encabezado -->
    <header class="mb-8 animate-fadeSlide">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
                <h1 class="text-4xl font-bold text-white flex items-center gap-4">
                    <span class="grid place-items-center w-12 h-12 rounded-lg bg-white text-black text-2xl font-bold">1</span>
                    Balance Energético
                </h1>
                <p class="text-lg text-cyan-300 mt-2">La base de la pirámide. Calcula tus calorías de mantenimiento y objetivo.</p>
            </div>
            <a href="{% url 'nutricion_app_django:vista_lista_niveles' %}" class="btn-secondary-outline">
                <i class="fas fa-arrow-left"></i> Volver a los Niveles
            </a>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
        <!-- Columna Izquierda: Formulario de Cálculo -->
        <div class="lg:col-span-3">
            <form method="post" id="nivel1-form" class="panel-card animate-fadeSlide" style="animation-delay: 0.2s;">
                {% csrf_token %}
                <h3 class="section-title"><i class="fas fa-calculator text-cyan-400"></i>Método de Cálculo</h3>

                <!-- Factor de Actividad -->
                <!-- En nivel1_balance.html -->

                <!-- Factor de Actividad -->
                <div class="mb-6">
                    <label for="factor-slider" class="form-label text-lg">Factor de Actividad</label>
                    <div class="flex items-center gap-4 mt-2">
                        <input type="range" class="form-range w-full" id="factor-slider" min="1.3" max="2.2" step="0.05">

                        <!--
                            CAMPO CLAVE: Un único campo oculto con el 'name' correcto.
                            El JavaScript le dará el valor.
                        -->
                        <input type="hidden" name="factor_actividad" id="factor_actividad_hidden_input">

                        <!-- El campo de texto que solo sirve para mostrar el valor -->
                        <input type="text" id="factor_actividad_display" class="bg-gray-900 border-gray-700 text-white font-bold text-center rounded-lg w-24 p-2" readonly>
                    </div>
                </div>


                <!-- Descripción del Factor -->
                <!-- Descripción del Factor (Versión Mejorada) -->
                <div class="info-box mb-8">
                    <!-- Título dinámico que cambia con el slider -->
                    <div id="factor-description" class="text-cyan-300 font-semibold mb-3 text-lg">
                        <!-- El JavaScript actualizará este título -->
                    </div>

                    <!-- Guía detallada y estática para el usuario -->
                    <ul class="space-y-2 text-xs text-gray-400">
                        <li>
                            <strong class="text-gray-200">1.3 - 1.45: Sedentario</strong>

                            Trabajo de oficina, poco o ningún ejercicio planificado.
                        </li>
                        <li>
                            <strong class="text-gray-200">1.5 - 1.65: Ligeramente Activo</strong>

                            Trabajo sedentario + entrenamiento ligero 1-3 días/semana.
                        </li>
                        <li>
                            <strong class="text-gray-200">1.7 - 1.85: Activo</strong>

                            Entrenamiento moderado/intenso 3-5 días/semana.
                        </li>
                        <li>
                            <strong class="text-gray-200">1.9 - 2.05: Muy Activo</strong>

                            Entrenamiento intenso 6-7 días/semana o trabajo físicamente activo.
                        </li>
                        <li>
                            <strong class="text-gray-200">2.1 - 2.2: Extremadamente Activo</strong>

                            Trabajo muy físico (ej. construcción) + entrenamiento diario.
                        </li>
                    </ul>
                </div>


                <!-- Botón de Envío -->
                <div class="text-center">
                    <button type="submit" class="block w-full bg-gradient-to-r from-cyan-500 to-fuchsia-500 text-white text-center font-semibold py-2 rounded-xl mt-6 shadow-md hover:scale-105 transition">
                        <i class="fas fa-bolt"></i> Calcular y Guardar
                    </button>
                </div>
            </form>
        </div>

        <!-- Columna Derecha: Resultados y Recomendaciones -->
        <div class="lg:col-span-2 space-y-8">
            <!-- Resultados -->
            {% if ultimo_calculo %}
            <div class="panel-card animate-fadeSlide" style="animation-delay: 0.3s;">
                <h3 class="section-title"><i class="fas fa-chart-bar text-cyan-400"></i>Tus Resultados</h3>
                <ul class="space-y-3">
                    <li class="flex justify-between items-center">
                        <span class="text-gray-400">Mantenimiento:</span>
                        <span class="font-semibold text-xl">{{ ultimo_calculo.calorias_mantenimiento|floatformat:0 }} kcal</span>
                    </li>
                    <li class="flex justify-between items-center text-lg">
                        <span class="text-gray-300 font-semibold">Objetivo:</span>
                        <span class="font-bold text-2xl {% if diferencia_calorica < 0 %}text-red-400{% elif diferencia_calorica > 0 %}text-green-400{% else %}text-blue-400{% endif %}">
                            {{ ultimo_calculo.calorias_objetivo|floatformat:0 }} kcal
                        </span>
                    </li>
                    {% if diferencia_calorica != 0 %}
                    <li class="flex justify-between items-center text-sm">
                        <span class="text-gray-400">Ajuste:</span>
                        <span class="font-semibold {% if diferencia_calorica < 0 %}text-red-400{% else %}text-green-400{% endif %}">
                            {{ diferencia_calorica|floatformat:0 }} kcal ({{ ultimo_calculo.deficit_superavit_porcentaje|floatformat:1 }}%)
                        </span>
                    </li>
                    {% endif %}
                    <li class="flex justify-between items-center text-sm">
                        <span class="text-gray-400">Cambio de peso esperado:</span>
                        <span class="font-semibold">{{ peso_objetivo_semanal|floatformat:2 }} kg/semana</span>
                    </li>
                </ul>
                <p class="text-xs text-center text-gray-500 mt-4">Calculado el {{ ultimo_calculo.fecha_calculo|date:"d/m/Y" }}</p>
            </div>
            {% endif %}

            <!-- Recomendaciones -->
            {% if recomendaciones %}
            <div class="panel-card animate-fadeSlide" style="animation-delay: 0.4s;">
                <h3 class="section-title"><i class="fas fa-lightbulb text-cyan-400"></i>Recomendaciones</h3>
                <ul class="space-y-2 text-sm text-gray-300 list-disc list-inside">
                    {% for recomendacion in recomendaciones %}
                    <li>{{ recomendacion }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Acciones -->
            <div class="animate-fadeSlide" style="animation-delay: 0.5s;">
                {% if ultimo_calculo %}
                <a href="{% url 'nutricion_app_django:nivel2_macros' %}" class="block w-full bg-gradient-to-r from-cyan-500 to-fuchsia-500 text-white text-center font-semibold py-2 rounded-xl mt-6 shadow-md hover:scale-105 transition">
                    Continuar al Nivel 2 <i class="fas fa-arrow-right"></i>
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const factorSlider = document.getElementById('factor-slider');
        const displayInput = document.getElementById('factor_actividad_display');
        const hiddenInput = document.getElementById('factor_actividad_hidden_input');
        const descElement = document.getElementById('factor-description');

        const initialValue = parseFloat("{{ ultimo_calculo.factor_actividad|default:'1.7'|stringformat:'f' }}");

        // --- FUNCIÓN DE DESCRIPCIÓN MEJORADA ---
        function updateDescription(factor) {
            if (!descElement) return;
            let description = '';
            if (factor <= 1.45) {
                description = `Sedentario`;
            } else if (factor <= 1.65) {
                description = `Ligeramente Activo`;
            } else if (factor <= 1.85) {
                description = `Activo`;
            } else if (factor <= 2.05) {
                description = `Muy Activo`;
            } else {
                description = `Extremadamente Activo`;
            }
            // Actualizamos solo el título, la guía detallada es estática.
            descElement.innerHTML = `Nivel Seleccionado: <strong>${description}</strong>`;
        }

        function syncValues(value) {
            const numericValue = parseFloat(value);
            displayInput.value = numericValue.toFixed(2);
            hiddenInput.value = numericValue.toFixed(2);
            updateDescription(numericValue);
        }

        if (factorSlider && displayInput && hiddenInput) {
            factorSlider.value = initialValue;
            syncValues(initialValue);
            factorSlider.addEventListener('input', (event) => {
                syncValues(event.target.value);
            });
        }
    });
</script>
{% endblock %}