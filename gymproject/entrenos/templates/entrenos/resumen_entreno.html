{% extends 'base.html' %}
{% load static %}
{% load entreno_tags %}

{% block title %}Resumen de Entreno{% endblock %}

{% block content %}
<style>
    .fade-in-card {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    }
    .fade-in-card.visible {
        opacity: 1;
        transform: translateY(0);
    }
    .card.fade-in-card span.me-2 {
        animation: bounce 1.5s ease infinite;
    }
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-4px); }
    }
    .perfect-icon {
        font-size: 2.5rem;
        display: inline-block;
        animation: bounce-scale 1.5s ease infinite;
    }
    @keyframes bounce-scale {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.3); }
    }
    .confeti-overlay {
        position: fixed;
        pointer-events: none;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        overflow: hidden;
    }
    .confeti {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: hsl(var(--hue, 200), 100%, 50%);
        animation: confeti-fall 3s linear forwards;
        border-radius: 2px;
    }
    @keyframes confeti-fall {
        0% { transform: translateY(0) rotate(0deg); opacity: 1; }
        100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
    }
</style>

<div class="apple-fitness-container">
    <script id="logros-hoy-data" type="application/json">{{ logros_hoy_json|safe }}</script>
    <script id="sugerencias-inteligentes-data" type="application/json">{{ sugerencias_inteligentes_json|safe }}</script>
    <script id="predicciones-progreso-data" type="application/json">{{ predicciones_progreso_json|safe }}</script>
    <script id="medallas-logros-data" type="application/json">{{ medallas_logros_json|safe }}</script>
    <script id="leaderboard-data" type="application/json">{{ leaderboard_json|safe }}</script>
    <script id="entreno-actual-data" type="application/json">{{ entreno_actual_json|safe }}</script>
    <script id="progreso-por-ejercicio-data" type="application/json">{{ progreso_por_ejercicio_json|safe }}</script>

    <h1 class="mb-4">Resumen de Entrenamiento</h1>

    <div class="card mb-4"><div class="card-header bg-primary text-white">Logros de Hoy</div><div class="card-body" id="logros-hoy-container"><p class="text-muted">Cargando logros...</p></div></div>
    <div class="card mb-4"><div class="card-header bg-success text-white">Sugerencias Inteligentes</div><div class="card-body" id="sugerencias-container"><p class="text-muted">Cargando sugerencias...</p></div></div>
    <div class="card mb-4"><div class="card-header bg-warning text-white">Predicciones de Progreso</div><div class="card-body" id="predicciones-container"><p class="text-muted">Cargando predicciones...</p></div></div>
    <div class="card mb-4"><div class="card-header bg-info text-white">Tus Medallas y Logros</div><div class="card-body" id="medallas-logros-container"><p class="text-muted">Cargando tus medallas y logros...</p></div></div>
    <div class="card mb-4"><div class="card-header bg-danger text-white">Tablas de Clasificaci√≥n</div><div class="card-body" id="leaderboard-container"><p class="text-muted">Cargando clasificaciones...</p></div></div>
    <div class="card mb-4"><div class="card-header bg-dark text-white">Detalles del Entrenamiento Actual</div><div class="card-body" id="entreno-actual-container"><p class="text-muted">Cargando detalles...</p></div></div>
    <div class="card mb-4"><div class="card-header bg-secondary text-white">Progreso por Ejercicio</div><div class="card-body" id="graficos-progreso-container"><p class="text-muted">Cargando gr√°ficas...</p></div></div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.card').forEach((card, index) => {
        card.classList.add('fade-in-card');
        setTimeout(() => {
            card.classList.add('visible');
        }, 200 + index * 150);
    });

    function lanzarConfeti() {
        const confeti = document.createElement('div');
        confeti.classList.add('confeti-overlay');
        document.body.appendChild(confeti);
        for (let i = 0; i < 100; i++) {
            const part = document.createElement('div');
            part.className = 'confeti';
            part.style.left = Math.random() * 100 + 'vw';
            part.style.animationDelay = (Math.random() * 2) + 's';
            confeti.appendChild(part);
        }
        setTimeout(() => confeti.remove(), 4000);
    }

    function loadDataIntoContainer(dataId, containerId, renderFunction) {
        const dataElement = document.getElementById(dataId);
        const container = document.getElementById(containerId);
        if (dataElement && container) {
            try {
                const data = JSON.parse(dataElement.textContent);
                renderFunction(data, container);
            } catch (e) {
                console.error(`Error parsing data from ${dataId}:`, e);
                container.innerHTML = '<p class="text-danger">No se pudieron cargar los datos. Por favor, recarga la p√°gina o int√©ntalo m√°s tarde.</p>';
            }
        }
    }

    function renderLogrosHoy(data, container) {
        if (data.mensaje) {
            container.innerHTML = `<p>${data.mensaje}</p><p><strong>${data.total_peso_levantado_hoy} kg</strong> levantados hoy.</p>`;
        } else {
            container.innerHTML = '<p class="text-muted">No hay logros registrados.</p>';
        }
    }

    function renderSugerencias(data, container) {
        if (data.length > 0) {
            container.innerHTML = '<ul>' + data.map(s => `<li>${s}</li>`).join('') + '</ul>';
        } else {
            container.innerHTML = '<p class="text-muted">No hay sugerencias por ahora.</p>';
        }
    }

    function renderPredicciones(data, container) {
        if (data.mensaje) {
            const color = data.tendencia === 'ascendente' ? 'success' : data.tendencia === 'descendente' ? 'danger' : 'secondary';
            const porcentaje = data.tendencia === 'ascendente' ? 80 : data.tendencia === 'descendente' ? 30 : 50;
            container.innerHTML = `
                <p>${data.mensaje}</p>
                <div class="progress">
                    <div class="progress-bar bg-${color}" style="width:${porcentaje}%">${porcentaje}%</div>
                </div>`;
        } else {
            container.innerHTML = '<p class="text-muted">No hay datos suficientes.</p>';
        }
    }

    function renderMedallasLogros(data, container) {
        if (data.length > 0) {
            container.innerHTML = '<ul class="list-unstyled">' +
                data.map(item => `
                    <li class="mb-2 d-flex align-items-start">
                        <span class="me-2" style="font-size: 1.2rem;">üèÖ</span>
                        <div><strong class="text-primary">${item.nombre}</strong><br><small>${item.descripcion}</small></div>
                    </li>`).join('') + '</ul>';
        } else {
            container.innerHTML = '<p class="text-muted">A√∫n no tienes medallas.</p>';
        }
    }

    function renderLeaderboard(data, container) {
        if (data.length > 0) {
            container.innerHTML = '<ul class="list-unstyled">' +
                data.map((item, i) => `<li><strong>${i+1}. ${item.nombre}</strong>: ${item.valor} ${item.unidad}</li>`).join('') +
                '</ul>';
        } else {
            container.innerHTML = '<p class="text-muted">Sin datos a√∫n.</p>';
        }
    }

    function renderEntrenoActual(data, container) {
        if (data.length === 0) {
            container.innerHTML = '<p class="text-muted">No se encontraron series.</p>';
            return;
        }
        let completadas = 0;
        let total = data.length;
        let html = '<table class="table"><thead><tr><th>Ejercicio</th><th>Serie</th><th>Reps</th><th>Peso</th><th>‚úì</th></tr></thead><tbody>';
        data.forEach(serie => {
            if (serie.completado) completadas++;
            html += `<tr><td>${serie.ejercicio_nombre}</td><td>${serie.serie_numero}</td><td>${serie.repeticiones}</td><td>${serie.peso_kg}</td><td>${serie.completado ? '‚úÖ' : '‚ùå'}</td></tr>`;
        });
        html += '</tbody></table>';
        const porcentaje = Math.round((completadas / total) * 100);
        const color = porcentaje === 100 ? 'success' : porcentaje >= 80 ? 'warning' : 'danger';
        html += `<div class="progress mb-2"><div class="progress-bar bg-${color}" style="width:${porcentaje}%">${porcentaje}%</div></div>`;
        if (porcentaje === 100) {
            html += `<div class="text-center mt-2"><span class="perfect-icon">üéØ</span><p class="text-success">¬°Entreno perfecto!</p></div>`;
            lanzarConfeti();
        }
        container.innerHTML = html;
    }

    function renderGraficasProgreso(data, container) {
        container.innerHTML = '';
        for (const ejercicio in data) {
            const graficoId = 'grafico-' + ejercicio.replace(/\s+/g, '-').toLowerCase();
            container.innerHTML += `<h6>${ejercicio}</h6><canvas id="${graficoId}" height="200"></canvas>`;
            const ctx = document.getElementById(graficoId).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data[ejercicio].labels,
                    datasets: [
                        { label: 'Peso (kg)', data: data[ejercicio].peso, borderColor: 'blue', fill: false, tension: 0.3 },
                        { label: 'Reps', data: data[ejercicio].reps, borderColor: 'green', fill: false, tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
    }

    loadDataIntoContainer('logros-hoy-data', 'logros-hoy-container', renderLogrosHoy);
    loadDataIntoContainer('sugerencias-inteligentes-data', 'sugerencias-container', renderSugerencias);
    loadDataIntoContainer('predicciones-progreso-data', 'predicciones-container', renderPredicciones);
    loadDataIntoContainer('medallas-logros-data', 'medallas-logros-container', renderMedallasLogros);
    loadDataIntoContainer('leaderboard-data', 'leaderboard-container', renderLeaderboard);
    loadDataIntoContainer('entreno-actual-data', 'entreno-actual-container', renderEntrenoActual);
    loadDataIntoContainer('progreso-por-ejercicio-data', 'graficos-progreso-container', renderGraficasProgreso);
});
</script>
{% endblock %}
