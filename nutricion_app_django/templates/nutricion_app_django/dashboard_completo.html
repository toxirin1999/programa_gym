{% extends 'nutricion_app_django/base_nutricion.html' %}
{% load static %}

{% block title %}Dashboard Completo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* Estilos Base del Mockup Cyberpunk */
    body {
        background: url("{% static 'images/fondo_cyberpunk.png' %}" ) no-repeat center center fixed !important;
        background-size: cover !important;
        background-color: #000000 !important;
        color: #e0e0e0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh !important;
        filter: brightness(0.9);
        overflow-x: hidden;
    }

    .dashboard-container {
        max-width: 1400px; /* Aumentamos el ancho para acomodar todo */
        margin: 2rem auto;
        padding: 1rem;
    }

    /* Paneles y Tarjetas con Estilo Cyberpunk */
    .glass-panel, .metric-card, .quote-box, .timeline-section {
        background: rgba(0, 0, 0, 0.4) !important;
        backdrop-filter: blur(15px) saturate(180%) !important;
        -webkit-backdrop-filter: blur(15px) saturate(180%) !important;
        border: 1px solid rgba(77, 208, 225, 0.6) !important;
        box-shadow: 0 0 15px rgba(77, 208, 225, 0.4), inset 0 0 8px rgba(77, 208, 225, 0.2) !important;
        border-radius: 10px !important;
        padding: 25px;
        margin-bottom: 25px;
        transition: all 0.3s ease;
    }
    .glass-panel:hover {
        border-color: rgba(0, 212, 170, 0.8) !important;
    }

    /* Títulos y Cabeceras */
    .dashboard-header { text-align: center; margin-bottom: 40px; }
    .dashboard-header h1 {
        font-size: 2rem;
        color: #00d4aa;
        letter-spacing: 2px;
        text-transform: uppercase;
        margin-bottom: 10px;
        text-shadow: 0 0 10px rgba(0, 212, 170, 0.5);
    }
    .dashboard-header p { color: #a0a0b0; font-size: 1rem; }
    .panel-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #f0f0f0;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(77, 208, 225, 0.3);
    }
    .panel-title i { margin-right: 12px; color: #00d4aa; }

    /* Estadísticas Principales */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; text-align: center; }
    .stat-item .value { font-size: 2.5rem; font-weight: 700; color: #00d4aa; }
    .stat-item .label { font-size: 0.9rem; color: #a0a0b0; margin-top: 5px; }

    /* Detalles y Listas */
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .detail-item { background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; }
    .detail-item .label { font-size: 0.85rem; color: #a0a0b0; margin-bottom: 5px; }
    .detail-item .value { font-size: 1.2rem; font-weight: 600; color: #e0e0e0; }
    .value.highlight { color: #00d4aa; font-size: 1.5rem; }

    .detail-list .label { font-size: 0.9rem; color: #a0a0b0; display: block; margin-bottom: 2px; }
    .detail-list .value { font-size: 1.1rem; font-weight: 500; color: #e0e0e0; margin-bottom: 15px; }

    /* Pirámide de Nutrición */
    .pyramid-container { display: flex; flex-direction: column-reverse; align-items: center; gap: 5px; }
    .pyramid-level {
        padding: 10px 20px;
        border-radius: 4px;
        color: white;
        font-weight: bold;
        text-align: center;
        transition: all 0.3s ease;
        font-size: 0.85rem;
        opacity: 0.4;
        border: 1px solid transparent;
    }
    .pyramid-level.completed {
        opacity: 1;
        box-shadow: 0 0 20px rgba(0, 212, 170, 0.7);
        border-color: rgba(0, 212, 170, 0.5);
        transform: scale(1.02);
    }
    .pyramid-level.nivel-1 { background: #2E8B57; width: 100%; }
    .pyramid-level.nivel-2 { background: #4682B4; width: 85%; }
    .pyramid-level.nivel-3 { background: #DAA520; width: 70%; }
    .pyramid-level.nivel-4 { background: #CD853F; width: 55%; }
    .pyramid-level.nivel-5 { background: #B22222; width: 40%; }

    /* Gráficos y Alertas */
    .chart-container { height: 350px; padding: 10px; }
    .alert-custom { padding: 15px; border-radius: 8px; border: 1px solid; margin-top: 15px; }
    .alert-success { background-color: rgba(40, 167, 69, 0.2); border-color: rgba(40, 167, 69, 0.5); color: #a8d5b5; }
    .alert-warning { background-color: rgba(255, 193, 7, 0.2); border-color: rgba(255, 193, 7, 0.5); color: #ffeeba; }
    .alert-custom a { font-weight: bold; color: #00d4aa; text-decoration: none; }

    /* Botones */
    .btn-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .btn-glass {
        background: transparent;
        border: 1px solid rgba(77, 208, 225, 0.6);
        color: #e0e0e0;
        padding: 12px 18px;
        border-radius: 8px;
        text-align: center;
        text-decoration: none;
        transition: all 0.3s ease;
        font-weight: 600;
    }
    .btn-glass:hover {
        background: rgba(0, 212, 170, 0.2);
        border-color: #00d4aa;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 0 15px rgba(0, 212, 170, 0.5);
    }

    /* Suplementos */
    .supplement-badge {
        background-color: rgba(0, 212, 170, 0.2);
        color: #00d4aa;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        display: inline-block;
        margin-right: 8px;
        margin-bottom: 8px;
        border: 1px solid rgba(0, 212, 170, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">

    <div class="dashboard-header">
        <h1>Dashboard Nutricional Completo</h1>
        <p>Un resumen integral de tu plan nutricional basado en "The Muscle & Strength Pyramid".</p>
    </div>

    <!-- Fila 1: Estadísticas Principales y Pirámide -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="glass-panel h-100">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="value">{{ user_profile.peso|floatformat:1 }}</div>
                        <div class="label">Peso Actual (kg)</div>
                    </div>
                    <div class="stat-item">
                        <div class="value">{{ ultimo_calculo_nivel1.calorias_objetivo|default:"-"|floatformat:0 }}</div>
                        <div class="label">Calorías Objetivo</div>
                    </div>
                    <div class="stat-item">
                        <div class="value">{{ ultimo_calculo_nivel2.proteina_gramos|default:"-"|floatformat:0 }}</div>
                        <div class="label">Proteína (g/día)</div>
                    </div>
                    <div class="stat-item">
                        <div class="value">{{ niveles_completados }}/5</div>
                        <div class="label">Niveles Completados</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="glass-panel h-100">
                <h5 class="panel-title"><i class="fas fa-layer-group"></i>Progreso en la Pirámide</h5>
                <div class="pyramid-container">
                    <div class="pyramid-level nivel-5 {% if progreso.nivel_5_completado %}completed{% endif %}">NIVEL 5: SUPLEMENTOS</div>
                    <div class="pyramid-level nivel-4 {% if progreso.nivel_4_completado %}completed{% endif %}">NIVEL 4: TIMING</div>
                    <div class="pyramid-level nivel-3 {% if progreso.nivel_3_completado %}completed{% endif %}">NIVEL 3: MICROS</div>
                    <div class="pyramid-level nivel-2 {% if progreso.nivel_2_completado %}completed{% endif %}">NIVEL 2: MACROS</div>
                    <div class="pyramid-level nivel-1 {% if progreso.nivel_1_completado %}completed{% endif %}">NIVEL 1: BALANCE</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fila 2: Detalles de Niveles y Gráfico de Progreso -->
    <div class="row">
        <!-- Columna Izquierda: Detalles de los niveles -->
        <div class="col-lg-8">
            <!-- Balance Energético (Nivel 1) -->
            {% if ultimo_calculo_nivel1 %}
            <div class="glass-panel">
                <h5 class="panel-title"><i class="fas fa-balance-scale"></i>Balance Energético (Nivel 1)</h5>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="label">Calorías de Mantenimiento</div>
                        <div class="value">{{ ultimo_calculo_nivel1.calorias_mantenimiento|floatformat:0 }} kcal</div>
                    </div>
                    <div class="detail-item">
                        <div class="label">Calorías Objetivo ({{ user_profile.objetivo }})</div>
                        <div class="value highlight">{{ ultimo_calculo_nivel1.calorias_objetivo|floatformat:0 }} kcal</div>
                    </div>
                </div>
                {% if diferencia_calorica != 0 %}
                <div class="mt-3 alert-custom {% if diferencia_calorica > 0 %}alert-success{% else %}alert-warning{% endif %}">
                    {% if diferencia_calorica > 0 %}
                    <p class="mb-0"><strong>Superávit calórico:</strong> +{{ diferencia_calorica|floatformat:0 }} kcal/día para ganancia muscular.</p>
                    {% else %}
                    <p class="mb-0"><strong>Déficit calórico:</strong> {{ diferencia_calorica|floatformat:0 }} kcal/día para pérdida de grasa.</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Macronutrientes (Nivel 2) -->
            {% if ultimo_calculo_nivel2 %}
            <div class="glass-panel">
                <h5 class="panel-title"><i class="fas fa-chart-pie"></i>Distribución de Macronutrientes (Nivel 2)</h5>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="value">{{ ultimo_calculo_nivel2.proteina_gramos|floatformat:0 }}g</div>
                        <div class="label">Proteína</div>
                        <div class="small text-white-50">{{ calorias_macros.proteina|floatformat:0 }} kcal</div>
                    </div>
                    <div class="stat-item">
                        <div class="value">{{ ultimo_calculo_nivel2.grasa_gramos|floatformat:0 }}g</div>
                        <div class="label">Grasa</div>
                        <div class="small text-white-50">{{ calorias_macros.grasa|floatformat:0 }} kcal</div>
                    </div>
                    <div class="stat-item">
                        <div class="value">{{ ultimo_calculo_nivel2.carbohidratos_gramos|floatformat:0 }}g</div>
                        <div class="label">Carbohidratos</div>
                        <div class="small text-white-50">{{ calorias_macros.carbohidratos|floatformat:0 }} kcal</div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Micronutrientes y Agua (Nivel 3) -->
            {% if configuracion_nivel3 %}
            <div class="glass-panel">
                <h5 class="panel-title"><i class="fas fa-tint"></i>Hidratación y Micronutrientes (Nivel 3)</h5>
                <div class="detail-list">
                    <span class="label">Agua recomendada:</span>
                    <p class="value">{{ configuracion_nivel3.agua_litros|floatformat:1 }} litros/día</p>
                    <span class="label">Enfoque principal:</span>
                    <p class="value">Priorizar una dieta variada con frutas y verduras para asegurar la ingesta de micronutrientes esenciales.</p>
                </div>
            </div>
            {% endif %}

            <!-- Timing (Nivel 4) -->
            {% if configuracion_nivel4 %}
            <div class="glass-panel">
                <h5 class="panel-title"><i class="fas fa-clock"></i>Timing y Frecuencia (Nivel 4)</h5>
                <div class="detail-list">
                    <span class="label">Comidas por día:</span>
                    <p class="value">{{ configuracion_nivel4.comidas_por_dia }}</p>
                    <span class="label">Estrategia pre-entreno:</span>
                    <p class="value">{{ configuracion_nivel4.get_timing_pre_entreno_display }}</p>
                    <span class="label">Estrategia post-entreno:</span>
                    <p class="value">{{ configuracion_nivel4.get_timing_post_entreno_display }}</p>
                    <span class="label">Distribución de proteína:</span>
                    <p class="value">{{ configuracion_nivel4.get_distribucion_macros_display }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Suplementos (Nivel 5) -->
            {% if configuracion_nivel5 %}
            <div class="glass-panel">
                <h5 class="panel-title"><i class="fas fa-pills"></i>Suplementos (Nivel 5)</h5>
                <div class="detail-list">
                    <span class="label">Suplementos seleccionados:</span>
                    <div class="value mt-2">
                        {% for suplemento in configuracion_nivel5.get_suplementos_seleccionados %}
                        <span class="supplement-badge">{{ suplemento }}</span>
                        {% empty %}
                        <p>Ninguno seleccionado.</p>
                        {% endfor %}
                    </div>
                    {% if configuracion_nivel5.otros_suplementos %}
                    <span class="label">Otros suplementos:</span>
                    <p class="value">{{ configuracion_nivel5.otros_suplementos }}</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Columna Derecha: Gráfico, Próximos Pasos y Acciones -->
        <div class="col-lg-4">
            <!-- Progreso de Peso -->
            {% if historial_peso %}
            <div class="glass-panel">
                <h5 class="panel-title"><i class="fas fa-chart-line"></i>Progreso de Peso</h5>
                <div class="chart-container">
                    <canvas id="pesoChart"></canvas>
                </div>
            </div>
            {% endif %}

            <!-- Próximos Pasos -->
            <div class="glass-panel">
                <h5 class="panel-title"><i class="fas fa-shoe-prints"></i>Próximos Pasos</h5>
                {% if not progreso.nivel_1_completado %}
                <div class="alert-custom alert-warning">Completa el <a href="{% url 'nutricion_app_django:nivel1_balance' %}">Nivel 1: Balance Energético</a> para empezar.</div>
                {% elif not progreso.nivel_2_completado %}
                <div class="alert-custom alert-warning">Ahora, configura tus <a href="{% url 'nutricion_app_django:nivel2_macros' %}">Macronutrientes (Nivel 2)</a>.</div>
                {% elif not progreso.nivel_3_completado %}
                <div class="alert-custom alert-warning">Es hora de aprender sobre <a href="{% url 'nutricion_app_django:nivel3_micros' %}">Micronutrientes (Nivel 3)</a>.</div>
                {% elif not progreso.nivel_4_completado %}
                <div class="alert-custom alert-warning">Optimiza el <a href="{% url 'nutricion_app_django:nivel4_timing' %}">Timing de tus comidas (Nivel 4)</a>.</div>
                {% elif not progreso.nivel_5_completado %}
                <div class="alert-custom alert-warning">Finalmente, considera los <a href="{% url 'nutricion_app_django:nivel5_suplementos' %}">Suplementos (Nivel 5)</a>.</div>
                {% else %}
                <div class="alert-custom alert-success">¡Felicidades! Has completado todos los niveles de la pirámide.</div>
                {% endif %}
            </div>

            <!-- Acciones Rápidas -->
            <div class="glass-panel">
                <h5 class="panel-title"><i class="fas fa-bolt"></i>Acciones Rápidas</h5>
                <div class="btn-grid">
                    <a href="{% url 'nutricion_app_django:seguimiento_peso' %}" class="btn-glass"><i class="fas fa-weight-scale"></i> Registrar Peso</a>
                    <a href="{% url 'nutricion_app_django:configurar_perfil' %}" class="btn-glass"><i class="fas fa-user-edit"></i> Editar Perfil</a>
                    <a href="{% url 'nutricion_app_django:piramide_principal' %}" class="btn-glass"><i class="fas fa-home"></i> Volver al Inicio</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if historial_peso %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function( ) {
        const ctx = document.getElementById('pesoChart').getContext('2d');
        if (ctx) {
            const historialPeso = {{ historial_peso_json|safe }};
            const labels = historialPeso.map(r => new Date(r.fecha).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }));
            const data = historialPeso.map(r => r.peso);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Peso (kg)',
                        data: data,
                        borderColor: '#00d4aa',
                        backgroundColor: 'rgba(0, 212, 170, 0.15)',
                        borderWidth: 2.5,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#00d4aa',
                        pointRadius: 4,
                        pointHoverRadius: 7,
                        pointBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.7)',
                            titleFont: { size: 14 },
                            bodyFont: { size: 12 },
                            padding: 10,
                            cornerRadius: 5
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { color: 'rgba(77, 208, 225, 0.15)' }
                        },
                        y: {
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { color: 'rgba(77, 208, 225, 0.15)' }
                        }
                    }
                }
            });
        }
    });
</script>
{% endif %}
{% endblock %}
